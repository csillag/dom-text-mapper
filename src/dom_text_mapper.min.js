(function(){window.DomTextMapper=function(){function t(){this.setRealRoot(),this.restrictToSerializable(!1)}var e,n,o;return o=!0,n=!0,e=32,t.prototype.restrictToSerializable=function(t){return null==t&&(t=!0),this.restricted=t},t.prototype.setRootNode=function(t){return this.rootWin=window,this.pathStartNode=this.rootNode=t},t.prototype.setRootId=function(t){return this.setRootNode(document.getElementById(t))},t.prototype.setRootIframe=function(t){var e;if(e=window.document.getElementById(t),null==e)throw Error("Can't find iframe with specified ID!");if(this.rootWin=e.contentWindow,null==this.rootWin)throw Error("Can't access contents of the spefified iframe!");return this.rootNode=this.rootWin.document,this.pathStartNode=this.getBody()},t.prototype.setRealRoot=function(){return this.rootWin=window,this.rootNode=document,this.pathStartNode=this.getBody()},t.prototype.documentChanged=function(){return this.lastDOMChange=this.timestamp()},t.prototype.getAllPaths=function(){var t,e,n,o,r;if(this.domStableSince(this.lastCollectedPaths))return this.restricted?this.cleanPaths:this.allPaths;if(o=this.timestamp(),this.saveSelection(),this.allPaths={},this.collectPathsForNode(this.pathStartNode),this.restoreSelection(),this.lastCollectedPaths=this.timestamp(),console.log("Path traversal took "+(this.lastCollectedPaths-o)+" ms."),this.restricted){this.cleanPaths={},r=this.allPaths;for(n in r)e=r[n],t=$.extend({},e),delete t.node,this.cleanPaths[n]=t;return this.cleanPaths}return this.allPaths},t.prototype.getDefaultPath=function(){return this.getPathTo(this.pathStartNode)},t.prototype.selectPath=function(t,e){var n,o;return null==e&&(e=!1),n=this.allPaths[t],this.selectNode(null!=(o=n.node)?o:this.lookUpNode(n.path))},t.prototype.scan=function(t){var e;return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),t===this.scannedPath&&this.domStableSince(this.lastScanned)?void 0:(this.getAllPaths(),e=this.allPaths[t].node,this.mappings={},this.saveSelection(),this.collectStrings(e,t,null,0,0),this.restoreSelection(),this.scannedPath=t,this.lastScanned=this.timestamp(),this.corpus=this.mappings[t].pathInfo.content,null)},t.prototype.performUpdateOnNode=function(t,e){var n,o,r,a,s,i,l,h,d,p,u,c,f,g,m;if(null==e&&(e=!1),null==t)throw Error("Called performUpdate with a null node!");if(c=this.timestamp(),e||this.saveSelection(),h=this.getPathTo(t),d=this.allPaths[h],null==d)throw Error("Can not find path info for path "+h);if(null==this.mappings[h])throw new error("Can not find mappings for path "+h);if(d.node===t&&d.content===this.getNodeContent(t)){u=h+"/",p=r,p=[],m=this.allPaths;for(r in m)n=m[r],this.stringStartsWith(r,u)&&p.push(r);for(f=0,g=p.length;g>f;f++)r=p[f],delete this.mappings[r],delete this.allPaths[r];if(this.collectPathsForNode(t),d.node===this.pathStartNode)console.log("Ended up rescanning the whole doc."),this.collectStrings(t,h,null,0,0);else{if(i=this.parentPath(h),l=this.allPaths[i],null==l)throw Error("While performing update on node "+h+", no path info found for parent path: "+i);if(a=this.mappings[i],null==a)throw Error("While performing update on node "+h+", no mappings info found for parent path: "+i);o=this.mappings[h].start-a.start,this.collectStrings(t,h,l.content,a.start,o)}}else{if(d.node===this.pathStartNode)throw console.log("I can not go up, since I'm already at path start node. Barking out."),Error("Can not keep up with the changes, since even the node configured as path start node was replaced.");s=null!=t.parentNode?t.parentNode:(i=this.parentPath(h),this.lookUpNode(i)),this.performUpdateOnNode(s,!0)}return e?void 0:this.restoreSelection()},t.prototype.getRangeForPath=function(t){var e;if(e=this.mappings[t],null==e)throw Error("Found no range for path '"+t+"'!");return this.restricted&&(e=$.extend({},e),e.pathInfo=$.extend({},e.pathInfo),delete e.pathInfo.node),e},t.prototype.getMappingsForRanges=function(t,e){var n,o,r,a,s,i;return null==e&&(e=null),a=function(){var n,o,a;for(a=[],n=0,o=t.length;o>n;n++)i=t[n],a.push(r=this.getMappingsForRange(i.start,i.end,e));return a}.call(this),this.restricted&&(a=function(){var t,e,i;for(i=[],t=0,e=a.length;e>t;t++)r=a[t],n=$.extend({},r),delete n.range,n.nodes=function(){var t,e,r,a;for(r=n.nodes,a=[],t=0,e=r.length;e>t;t++)s=r[t],o=$.extend({},s),o.element=$.extend({},o.element),o.element.pathInfo=$.extend({},o.element.pathInfo),delete o.element.pathInfo.node,a.push(o);return a}(),i.push(n);return i}()),a},t.prototype.getContentForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.allPaths[t].content},t.prototype.getLengthForPath=function(t){return null==t&&(t=null),null==t&&(t=this.getDefaultPath()),this.allPaths[t].length},t.prototype.getContentForRange=function(t,e,n){return null==n&&(n=null),this.getContentForPath(n).substr(t,e-t)},t.prototype.getContextForRange=function(t,n){var o,r,a,s,i;return o=this.getContentForPath(),s=Math.max(0,t-e),a=t-s,r=o.substr(s,a),i=o.substr(n,a),[r.trim(),i.trim()]},t.prototype.getMappingsForRange=function(t,e,n){var o,r,a,s,i,l,h,d,p,u,c,f,g,m,N,P,y=this;if(null==n&&(n=null),null==t||null==e)throw Error("start and end is required!");if(null!=n&&this.scan(n),null==this.scannedPath)throw Error("Can not run getMappingsFor() without existing mappings. Either supply a path to scan, or call scan() beforehand!");h=[],P=this.mappings;for(d in P)l=P[d],l.atomic&&this.regions_overlap(l.start,l.end,t,e)&&function(n){var o,r;return r={element:n},o=n.start>=t&&e>=n.end,o?(r.full=!0,r.wanted=n.content):n.start>=t?(r.end=e-n.start,r.wanted=n.pathInfo.content.substr(0,r.end)):e>=n.end?(r.start=t-n.start,r.wanted=n.pathInfo.content.substr(r.start)):(r.start=t-n.start,r.end=e-n.start,r.wanted=n.pathInfo.content.substr(r.start,r.end-r.start)),y.computeSourcePositions(r),r.yields=n.pathInfo.node.data.substr(r.startCorrected,r.endCorrected-r.startCorrected),h.push(r)}(l);if(0===h.length)throw Error("No matches found for ["+t+":"+e+"]!");return p=this.rootWin.document.createRange(),f=h[0],g=f.element.pathInfo.node,N=f.element.pathInfo.path,m=f.startCorrected,f.full?(p.setStartBefore(g),c=N):(p.setStart(g,m),c=N+":"+m),r=h[h.length-1],a=r.element.pathInfo.node,i=r.element.pathInfo.path,s=r.endCorrected,r.full?(p.setEndAfter(a),o=i):(p.setEnd(a,s),o=i+":"+s),u={nodes:h,range:p,rangeInfo:{startPath:N,startOffset:m,startInfo:c,endPath:i,endOffset:s,endInfo:o},safeParent:p.commonAncestorContainer}},t.prototype.timestamp=function(){return(new Date).getTime()},t.prototype.stringStartsWith=function(t,e){return e===t.substr(0,e.length)},t.prototype.parentPath=function(t){return t.substr(0,t.lastIndexOf("/"))},t.prototype.domChangedSince=function(t){return null!=this.lastDOMChange&&null!=t?this.lastDOMChange>t:!0},t.prototype.domStableSince=function(t){return!this.domChangedSince(t)},t.prototype.getProperNodeName=function(t){var e;switch(e=t.nodeName){case"#text":return"text()";case"#comment":return"comment()";case"#cdata-section":return"cdata-section()";default:return e}},t.prototype.getPathTo=function(t){var e,n,o;for(o="";t!==this.rootNode;){for(e=0,n=t;n;)n.nodeName===t.nodeName&&e++,n=n.previousSibling;o=this.getProperNodeName(t)+(e>1?"["+e+"]":"")+"/"+o,t=t.parentNode}return o=(null!=this.rootNode.ownerDocument?"./":"/")+o,o=o.replace(/\/$/,"")},t.prototype.collectPathsForNode=function(t){var e,n,o,r,a,s;if(n=this.getNodeContent(t,!1),n.length&&(o=this.getPathTo(t),this.allPaths[o]={path:o,content:n,length:n.length,node:t}),t.hasChildNodes())for(s=t.childNodes,r=0,a=s.length;a>r;r++)e=s[r],this.collectPathsForNode(e);return null},t.prototype.getBody=function(){return this.rootWin.document.getElementsByTagName("body")[0]},t.prototype.regions_overlap=function(t,e,n,o){return o>t&&e>n},t.prototype.lookUpNode=function(t){var e,n,o,r;return e=null!=(r=this.rootNode.ownerDocument)?r:this.rootNode,o=e.evaluate(t,this.rootNode,null,0,null),n=o.iterateNext()},t.prototype.saveSelection=function(){var t,e,n,o,r;for(e=this.rootWin.getSelection(),t=n=0,o=e.rangeCount;o>=0?o>n:n>o;t=o>=0?++n:--n)this.oldRanges=e.getRangeAt(t);switch(e.rangeCount){case 0:return null!=(r=this.oldRanges)?r:this.oldRanges=[];case 1:return this.oldRanges=[this.oldRanges]}},t.prototype.restoreSelection=function(){var t,e,n,o,r,a;for(e=this.rootWin.getSelection(),e.removeAllRanges(),r=this.oldRanges,a=[],n=0,o=r.length;o>n;n++)t=r[n],a.push(e.addRange(t));return a},t.prototype.selectNode=function(t,e){var r,a,s,i,l;if(null==e&&(e=!1),s=this.rootWin.getSelection(),s.removeAllRanges(),a=this.rootWin.document.createRange(),o&&t.nodeType===Node.ELEMENT_NODE&&("thead"===(l=t.tagName.toLowerCase())||"tbody"===l)&&t.hasChildNodes()?(r=t.childNodes,a.setStartBefore(r[0]),a.setEndAfter(r[r.length-1]),s.addRange(a)):n&&t.nodeType===Node.TEXT_NODE&&"table"===t.parentNode.tagName.toLowerCase()||(a.setStartBefore(t),a.setEndAfter(t),s.addRange(a)),e){for(i=t;null==i.scrollIntoViewIfNeeded;)i=i.parentNode;i.scrollIntoViewIfNeeded()}return s},t.prototype.getNodeSelectionText=function(t,e){var n,o;return null==e&&(e=!0),e&&this.saveSelection(),n=this.selectNode(t),o=(""+n).trim().replace(/\n/g," ").replace(/[ ][ ]+/g," "),e&&this.restoreSelection(),o},t.prototype.computeSourcePositions=function(t){var e,n,o,r,a,s,i,l,h,d;for(d=t.element.pathInfo.node.data.replace(/\n/g," "),a=t.element.pathInfo.content,r=null!=t.start?t.start:0,n=null!=t.end?t.end:a.length,l=0,o=0;null==h||null==i;)s=d[l],e=a[o],s===e&&(o===r&&(h=l),o++,o===n&&(i=l+1)),l++;return t.startCorrected=h,t.endCorrected=i,null},t.prototype.getNodeContent=function(t,e){return null==e&&(e=!0),this.getNodeSelectionText(t,e)},t.prototype.collectStrings=function(t,e,n,o,r){var a,s,i,l,h,d,p,u,c,f,g,m,N,P;if(null==n&&(n=null),null==o&&(o=0),null==r&&(r=0),g=this.allPaths[e],h=null!=g?g.content:void 0,null==h||""===h)return r;if(N=null!=n?n.indexOf(h,r):r,-1===N)return r;if(d=N+h.length,a=!t.hasChildNodes(),this.mappings[e]={pathInfo:g,start:o+N,end:o+d,atomic:a},this.declareMappings&&console.log("Found mappings for ["+this.mappings[e].start+":"+this.mappings[e].end+"]: "+g.content),!a)for(l=t.childNodes,p=0,m=0,P={};l.length>p;)s=l[p],c=this.getProperNodeName(s),f=P[c],u=null!=f?f+1:1,P[c]=u,i=e+"/"+c+(u>1?"["+u+"]":""),m=this.collectStrings(s,i,h,o+N,m),p++;return d},t}()}).call(this);